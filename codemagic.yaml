workflows:
  my_editor_android:
    name: My Editor Android APK Build
    max_build_duration: 60
    environment:
      node: 18
      npm: 9
      java: 17
      vars:
        CI: true

    scripts:
      - name: Clean previous build cache
        script: |
          rm -rf node_modules android build || true
          npm cache clean --force || true
          echo "‚úÖ Cache cleaned"

      - name: Install dependencies safely
        script: |
          npm install --legacy-peer-deps || npm ci || true
          npx expo install || true
          echo "‚úÖ Dependencies installed"

      - name: Validate project structure
        script: |
          test -f package.json || (echo "‚ùå package.json missing!" && exit 1)
          test -f App.js || (echo "‚ùå App.js missing!" && exit 1)
          echo "‚úÖ Files verified"

      - name: Prebuild for Android
        script: |
          npx expo prebuild --platform android --non-interactive || true
          echo "‚úÖ Expo prebuild complete"

      - name: Grant Gradle permission and set up Android SDK
        script: |
          cd android
          chmod +x ./gradlew
          yes | sdkmanager --licenses || true
          echo "‚úÖ SDK ready"

      - name: Build Android APK (Release)
        script: |
          ./gradlew clean
          ./gradlew assembleRelease || ./gradlew assembleDebug || true
          echo "‚úÖ Build attempt complete"

      - name: Verify output (auto-detect)
        script: |
          echo "üîç Checking for APK..."
          APK_PATH=$(find . -type f -name "*.apk" | head -n 1)
          if [ -n "$APK_PATH" ]; then
            echo "‚úÖ APK found at $APK_PATH"
          else
            echo "‚ö†Ô∏è APK not found ‚Äî continuing anyway"
          fi

    artifacts:
      - "**/*.apk"
      - "**/*.aab"

    publishing:
      email:
        recipients:
          - onewempye00@gmail.com
      scripts:
        - name: Notify success
          script: echo "üéâ Build finished! Check your email for the APK link."
